# 机器人数据模型重构文档

**日期**: 2026-02-04
**目的**: 简化数据模型，统一 `robot_components` 和 `_robot_high_risk_snapshots` 表结构，删除多余的 `WeeklyResult` 表

---

## 一、修改概述

### 问题背景
1. `robot_components` 表与 `_robot_high_risk_snapshots` 表字段结构不一致
2. A1-A7 字段存储类型错误（FloatField 而非 CharField），导致 "high" 状态无法正确显示红绿点
3. 存在多余的 `WeeklyResult` 表，功能与 `robot_components` 重复

### 解决方案
1. 统一两个表的字段结构，使其完全一致
2. 将 A1-A7 字段从 FloatField 改为 CharField，存储状态字符串（如 "high"）
3. 删除 `WeeklyResult` 表及相关代码

---

## 二、删除的内容

### 1. 删除的数据库表
| 表名 | 说明 |
|---|---|
| `weekly_results` | 周结果数据表（功能重复，已删除） |
| `high_risk_histories` | 旧的高风险历史表（如果存在，已删除） |

### 2. 删除的模型类
```python
# robots/models.py
class WeeklyResult(models.Model)  # 已删除
```

### 3. 删除的序列化器
```python
# robots/serializers.py
WeeklyResultSerializer
WeeklyResultListSerializer
WeeklyResultImportSerializer
WeeklyResultFileSerializer
```

### 4. 删除的视图
```python
# robots/views.py
class WeeklyResultViewSet  # 已删除
```

### 5. 删除的服务函数
```python
# robots/weekly_result_service.py
import_weeklyresult_csv()        # 导入到 WeeklyResult 表
sync_weeklyresult_to_robotcomponent()  # 从 WeeklyResult 同步
```

### 6. 删除的 API 路由
```
/api/robots/weekly-results/*  # 已删除
```

---

## 三、新增/修改的内容

### 1. 修改的模型

#### RobotComponent 模型
**A1-A7 字段类型变更**:
```python
# 修改前
a1 = models.FloatField(...)  # 错误：无法存储 "high" 字符串

# 修改后
a1 = models.CharField(max_length=16, null=True, blank=True, db_column='A1', verbose_name="A1")
# A2-A7 同理
```

**字段名变更**:
- 移除旧字段: `robot_id`, `part_no`, `name`, `reference_no`, `type_spec`, `checks`, `status`, `battery`, `health`, `motor_temp`, `network_latency`, `last_seen`, `risk_score`, `risk_level`, `risk_history`
- 使用 CSV 原始字段名: `robot`, `shop`, `reference`, `type`, `tech`, `A1-A7`

#### RobotHighRiskSnapshot 模型
**完全重构**，使其字段与 `RobotComponent` 完全一致：
```python
class RobotHighRiskSnapshot(models.Model):
    group = models.ForeignKey(RobotGroup, on_delete=models.RESTRICT, ...)
    robot = models.CharField(max_length=64, db_index=True, ...)
    shop = models.CharField(max_length=64, ...)
    # ... 所有字段与 RobotComponent 完全相同

    # A1-A7 存储状态字符串
    a1 = models.CharField(max_length=16, db_column='A1', ...)
    # A2-A7 同理

    level = models.CharField(max_length=1, default="H", ...)
```

### 2. 新增的 API 端点

```
POST /api/robots/components/import_csv/
```
直接导入 CSV 文件到 `robot_components` 表（替代原来的 weekly-results 导入）

**请求体**:
```json
{
    "folder_path": "/path/to/csv/folder",  // 可选
    "project": "reuse",                      // 可选
    "file_path": "/path/to/specific.csv"     // 可选
}
```

**响应**:
```json
{
    "success": true,
    "file": "/path/to/file.csv",
    "source_file": "1.31_weeklyresult.csv",
    "records_created": 100,
    "records_updated": 10,
    "total_records": 110,
    "shop_stats": {
        "MRA1 BS": {"created": 50, "updated": 5}
    }
}
```

### 3. 修改的 ViewSet

#### RobotComponentViewSet
- 修复 `bi_robots` action 中的字段引用（`robot_id` → `robot`, `part_no` → `robot`）
- 修复 `error_trend_chart` action 中的字段引用（`part_no` → `robot`）
- 新增 `import_csv` action

#### RobotHighRiskSnapshotViewSet
- 重命名 `HighRiskHistoryViewSet` → `RobotHighRiskSnapshotViewSet`
- 修复字段引用（`group_key` → `group__key`, `robot_id` → `robot`）
- 移除对不存在字段 `part_no` 和 `checks` 的引用

---

## 四、数据流程说明

### 修改后的数据流程

```
┌─────────────────┐
│  CSV 文件导入   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│  import_robot_components_csv()  │
│  (导入到 robot_components 表)    │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│     robot_components 表          │
│  - 存储所有当前数据               │
│  - 每次同步删除所有旧数据           │
│  - 导入新的 CSV 数据              │
└────────┬────────────────────────┘
         │
         │ level='H' 的数据
         ▼
┌─────────────────────────────────┐
│ _robot_high_risk_snapshots 表   │
│  - 只追加，不删除                │
│  - 累积所有历史高风险数据          │
└─────────────────────────────────┘
```

### 前端红绿点显示逻辑

**前端判断逻辑**:
```javascript
// 判断 A1-A7 是否为 "high"
const isCheckHigh = (robot, key) => {
    const axisKey = key.toUpperCase()  // 'a1' -> 'A1'
    const value = robot?.[axisKey]
    return value?.toLowerCase() === 'high'
}
```

**数据存储**:
- A1-A7 字段类型: `VARCHAR(16)`
- 存储值: `"high"`, `"ok"`, 或空字符串
- 数据库列名: `A1`, `A2`, ..., `A7`（大写）

---

## 五、数据库表结构对比

### robot_components 表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| group_id | BIGINT | 外键 → robot_groups.id |
| robot | VARCHAR(64) | 机器人编号 |
| shop | VARCHAR(64) | 车间 |
| reference | VARCHAR(64) | 参考编号 |
| type | VARCHAR(128) | 类型 |
| tech | VARCHAR(128) | 工艺 |
| mark | INT | 标记 |
| level | VARCHAR(1) | 等级 (H/M/L/T/C) |
| A1-A7 | VARCHAR(16) | **状态字符串** ("high", "ok") |
| a1_e_rate-a7_e_rate | FLOAT | 错误率 |
| a1_rms-a7_rms | FLOAT | RMS值 |
| curr_a1_max-curr_a7_max | FLOAT | 最大电流 |
| ... | ... | 其他测量字段 |

### _robot_high_risk_snapshots 表

**字段结构与 `robot_components` 完全相同**

用途：累积存储所有 `level='H'` 的历史数据，只追加不删除

---

## 六、迁移记录

### 迁移文件列表

| 迁移文件 | 说明 |
|----------|------|
| `0012_rebuild_high_risk_snapshots.py` | 重建 `_robot_high_risk_snapshots` 表，使其结构与 `robot_components` 一致 |
| `0013_update_weeklyresult_a1_a7_to_string.py` | 更新 `WeeklyResult` 的 A1-A7 字段为字符串（已废弃） |
| `0014_drop_weekly_results_table.py` | 删除 `weekly_results` 表 |

### 运行命令
```bash
python manage.py migrate robots
```

---

## 七、API 端点对照表

| 功能 | 旧端点 | 新端点 |
|------|--------|--------|
| 获取所有机器人 | `GET /api/robots/components/` | **保持不变** |
| 获取高风险机器人 | `GET /api/robots/components/?tab=highRisk` | **保持不变** |
| 获取历史高风险 | `GET /api/robots/high-risk-histories/` | **保持不变** |
| 导入 CSV | `POST /api/robots/weekly-results/import_csv/` | `POST /api/robots/components/import_csv/` |
| 获取 CSV 文件列表 | `GET /api/robots/weekly-results/files/` | **已删除** |
| 同步数据 | `POST /api/robots/weekly-results/sync_robot_status/` | **已删除** |
| 周结果统计 | `GET /api/robots/weekly-results/stats/` | **已删除** |

---

## 八、注意事项

### 1. CSV 导入时的 A1-A7 处理
```python
# 修改前（错误）
a1=safe_float(row.get('A1'))  # "high" 会被转换为 None

# 修改后（正确）
a1=safe_str(row.get('A1'))   # "high" 保持原样
```

### 2. 前端字段名大小写
- 数据库列名: `A1`, `A2`, ..., `A7`（大写）
- 模型字段名: `a1`, `a2`, ..., `a7`（小写）
- 前端访问: `robot.A1` 或 `robot.a1`（Django ORM 会自动映射）

### 3. 历史数据保留
- `_robot_high_risk_snapshots` 表的数据**不会删除**
- 每次导入 CSV 时，`level='H'` 的数据会自动追加到此表

---

## 九、验证检查

### 运行系统检查
```bash
python manage.py check
```

### 验证表结构
```python
from django.db import connection
cursor = connection.cursor()
cursor.execute('SHOW COLUMNS FROM robot_components LIKE "A%"')
```

### 测试 CSV 导入
```bash
curl -X POST http://localhost:8000/api/robots/components/import_csv/ \
  -H "Content-Type: application/json" \
  -d '{"folder_path": "/path/to/csv"}'
```

---

## 十、文件变更清单

### 修改的文件
- `robots/models.py` - 重构 RobotHighRiskSnapshot，删除 WeeklyResult
- `robots/serializers.py` - 删除 WeeklyResult 相关序列化器
- `robots/views.py` - 删除 WeeklyResultViewSet，修复字段引用
- `robots/urls.py` - 删除 weekly-results 路由
- `robots/weekly_result_service.py` - 删除相关函数，修复 A1-A7 处理

### 新增的文件
- `robots/migrations/0012_rebuild_high_risk_snapshots.py`
- `robots/migrations/0013_update_weeklyresult_a1_a7_to_string.py`
- `robots/migrations/0014_drop_weekly_results_table.py`

---

**文档生成时间**: 2026-02-04
**Django 版本**: 4.2.20
**Python 版本**: 3.13
