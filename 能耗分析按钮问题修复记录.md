# 能耗分析按钮问题修复记录

## 问题描述
- 页面顶部“能耗分析”按钮存在，但点击没有任何弹窗响应。
- 能耗分析图未显示，且无明显报错提示。

## 根因分析
- 弹窗 HTML 是通过 Bokeh 的 `Div` 组件注入到 Bokeh 布局中，真实 DOM 由 Bokeh 脚本在渲染时动态生成。
- 能耗图的脚本（`components(EnergyP)` 生成的 `energy_script_content`）会在 DOMContentLoaded 时尝试渲染到指定 div。
- 当脚本执行时，弹窗目标 div 尚未插入 DOM（仍在 Bokeh 布局渲染过程中），导致渲染失败。
- 按钮点击时 `document.getElementById(...)` 找不到弹窗节点，JS 逻辑直接 return，表现为“点击无响应”。

## 修改方案
- 将弹窗 HTML 与能耗图脚本从 Bokeh 布局中移出，改为直接输出到 Django 模板，确保页面加载时 DOM 即存在。
- Bokeh 按钮仍负责触发弹窗显示，但弹窗节点不再依赖 Bokeh 布局的渲染时机。

## 关键改动
### 1) Bokeh 端拆分弹窗与图表脚本
- 文件：`backend/robots/bokeh_charts.py`
- 变更：
  - 不再把 `energy_modal_html` 放进 `main_layout`。
  - 将 `energy_modal_html` 和 `energy_script_content` 作为额外返回值输出。

### 2) Django 视图转交模板渲染
- 文件：`backend/robots/views.py`
- 变更：
  - 接收 `energy_modal_html` 与 `energy_script`，注入到模板上下文。

### 3) 模板直接渲染弹窗与脚本
- 文件：`backend/templates/bi_embed.html`
- 变更：
  - 在 `{{ bokeh_div }}` 后插入 `{{ energy_modal_html }}`。
  - 在脚本区插入 `{{ energy_script }}`。

## 验证方式
1. 刷新 BI 页面。
2. 点击“能耗分析”按钮，弹窗应立即出现。
3. 弹窗内应正确渲染能耗图表。

## 相关文件
- `backend/robots/bokeh_charts.py`
- `backend/robots/views.py`
- `backend/templates/bi_embed.html`

