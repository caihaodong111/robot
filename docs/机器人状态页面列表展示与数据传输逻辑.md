# 机器人状态页面列表展示与数据传输逻辑

## 1. 页面列表与展示逻辑（前端）

### 1.1 车间列表与统计卡
- 入口：`frontend/src/views/devices/DevicesView.vue`
- 数据来源：`GET /robots/groups/`
- 展示方式：
  - 顶部 KPI 卡展示“当前监控车间 / 高风险数量 / 总数”
  - 抽屉列表展示所有车间，带高风险占比进度条
- 车间过滤：前端额外排除 `['', '(空)', 'MRA1 BS', '未分配']`

### 1.2 三个标签页列表
标签页位于同一表格区域，采用同一套筛选器，按标签页切换不同数据源与列结构。

#### A. 高风险机器人列表（highRisk）
- 标签名：`高风险机器人列表`
- 数据源：`GET /robots/components/`
- 查询参数：`tab=highRisk`，同时后端强制过滤 `level=H`
- 展示列：
  - 基础列（robot/reference/number/type/tech）
  - mark、remark、A1-A7 轴状态、level、Action
- 点击行为：
  - mark/remark/level 可编辑（弹窗编辑）
  - 轴状态可打开“错误率趋势图”

#### B. 所有机器人信息列表（all）
- 标签名：`所有机器人信息列表`
- 数据源：`GET /robots/components/`
- 查询参数：`tab=all`
- 展示列：
  - 基础列 + 大量详细字段（温度、错误率、RMS、E 值、Q 值、电流、P_Change、level）
  - A1-A7 列以点位形式展示，可打开趋势图

#### C. 历史高风险机器人列表（history）
- 标签名：`历史高风险机器人列表`
- 数据源：`GET /robots/high-risk-histories/`
- 查询参数：`group/level/keyword/page/page_size`（注意：`axisOk` 前端会传，但后端未使用）
- 展示列：
  - 与高风险列表一致（基础列 + mark/remark/轴状态/level/Action）
  - 不进行前端“高风险过滤”，直接展示历史快照

### 1.3 筛选与分页
- 公共筛选：
  - 关键词搜索（robot/partNo/reference/type/tech/remark）
  - 等级 level
  - Axis 轴筛选（A1-A7）+ 轴状态（正常/异常）
  - mark（0/非0）
- 行为策略：
  - 非搜索模式使用服务端分页
  - 搜索模式 `fetchAll=true`，请求 `page_size=10000`，前端二次过滤
  - 过滤条件变化时自动重置页码并重新拉取

### 1.4 辅助弹窗
- 详情弹窗：`Details` 只读展示基础字段
- 编辑弹窗：对 `reference/number/mark/remark/level` 进行 PATCH 更新
- 趋势图弹窗：点击轴状态点位触发，加载 base64 图片展示

## 2. 数据传输与接口逻辑（后端）

### 2.1 车间列表
- 入口：`backend/robots/views.py` → `RobotGroupViewSet.list`
- URL：`GET /robots/groups/`
- 统计字段：
  - `total`：组件总数
  - `highRisk`：`level=H` 数量
- 说明：后端会生成 `_stats`，由 `RobotGroupSerializer` 输出到 `stats` 字段

### 2.2 机器人列表（实时）
- 入口：`backend/robots/views.py` → `RobotComponentViewSet.get_queryset`
- URL：`GET /robots/components/`
- 关键参数：
  - `group`：按车间过滤
  - `tab`：`highRisk/all/history`
  - `keyword`：robot/shop/reference/type/tech/remark 关键词
  - `level`：等级过滤
  - `axisKeys` + `axisOk`：轴状态过滤
  - `markMode`：0/非0
  - `page/page_size`：分页
- 行为：
  - `tab=highRisk` 强制 `level=H`
  - `tab=history` 返回空集（前端应走 `/robots/high-risk-histories/`）

### 2.3 历史高风险快照
- 入口：`backend/robots/views.py` → `RobotHighRiskSnapshotViewSet.get_queryset`
- URL：`GET /robots/high-risk-histories/`
- 过滤参数：`group`、`level`、`keyword`
- 数据来源表：`_robot_high_risk_snapshots`

### 2.4 同步与更新时间
- 同步入口：`POST /robots/components/import_csv/`
  - 执行 CSV 导入并写入 `robot_components`
  - 归档上次高风险快照、写入同步日志
- 最近同步时间：`GET /robots/last_sync_time/`
  - 从 `refresh_logs` 读取最近成功同步时间

### 2.5 编辑与趋势图
- 编辑：`PATCH /robots/components/{id}/`
  - 更新 reference/number/mark/remark/level 等字段
- 错误率趋势图：`GET /robots/components/{id}/error_trend_chart/?axis=1-7`
  - 返回 base64 图像

## 3. 字段兼容与映射说明
- 后端主字段为 `robot/reference/type/tech/...`
- 前端兼容旧字段名：
  - `partNo` ⇄ `robot`
  - `referenceNo` ⇄ `reference`
  - `typeSpec` ⇄ `type`
- 轴状态读取兼容大小写：`A1` / `a1` 均可

## 4. 关键文件索引
- 前端主逻辑：`frontend/src/views/devices/DevicesView.vue`
- 前端 API：`frontend/src/api/robots.js`
- 后端视图：`backend/robots/views.py`
- 后端序列化：`backend/robots/serializers.py`
- 后端模型：`backend/robots/models.py`
