# 机器人状态页面数据处理和展示逻辑

## 一、概述

机器人状态页面（DevicesView）是一个完整的机器人监控系统，用于实时查看和管理多车间机器人的运行状态。系统采用前后端分离架构，后端使用 Django REST Framework，前端使用 Vue 3。

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (Vue 3 + Element Plus)               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  DevicesView.vue - 机器人状态页面                          │ │
│  │  - 车间选择  - 数据表格  - 过滤器  - 分页                 │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              ↓                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  robots.js - API接口层                                     │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    后端 API (Django REST Framework)              │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  views.py - 视图层                                         │ │
│  │  - RobotGroupViewSet                                      │ │
│  │  - RobotComponentViewSet                                  │ │
│  │  - WeeklyResultViewSet                                    │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              ↓                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  serializers.py - 序列化层                                 │ │
│  │  - RobotComponentSerializer                               │ │
│  │  - WeeklyResultListSerializer                             │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  数据库 (MySQL)                                                 │
│  ┌─────────────────┐  ┌─────────────────┐                     │
│  │ RobotGroup      │  │ RobotComponent  │                     │
│  │ - 车间信息       │←─│ - 机器人状态    │                     │
│  └─────────────────┘  │ - A1-A7检查     │                     │
│                       │ - 风险评估       │                     │
│                       └─────────────────┘                     │
│                              ↑                                  │
│                       CSV数据导入                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、核心数据模型

### 1. RobotComponent（机器人组件）

这是机器人状态的核心数据模型，存储机器人及其组件的实时状态信息。

```python
# backend/robots/models.py

class RobotComponent(models.Model):
    # 基本信息
    group = ForeignKey(RobotGroup, ...)      # 所属车间
    robot_id = CharField(max_length=64)      # 机器人ID
    part_no = CharField(max_length=64)       # 部件编号（表名）
    reference_no = CharField(max_length=64)  # 参考编号
    number = IntegerField(default=0)         # 编号
    type_spec = CharField(max_length=128)    # 类型
    tech = CharField(max_length=128)         # 工艺
    mark = IntegerField(default=0)           # 标记
    remark = TextField(blank=True)           # 备注

    # 状态信息
    level = CharField(choices=LEVEL_CHOICES, default="L")  # 等级: H/M/L/T/C
    status = CharField(choices=STATUS_CHOICES, default="online")  # online/offline
    checks = JSONField(default=dict)        # A1-A7关节检查结果

    # 风险信息
    risk_score = PositiveSmallIntegerField(default=0)     # 风险分数
    risk_level = CharField(...)                           # 风险等级
    risk_history = JSONField(default=list)                # 历史风险记录
```

**checks 字段结构**：
```json
{
  "A1": {"ok": true, "value": 0.5},
  "A2": {"ok": false, "value": 8.2},
  "A3": {"ok": true, "value": 1.1},
  "A4": {"ok": true, "value": 0.3},
  "A5": {"ok": true, "value": 2.5},
  "A6": {"ok": false, "value": 12.1},
  "A7": {"ok": true, "value": 0.9}
}
```

### 2. RobotGroup（车间/分组）

```python
class RobotGroup(models.Model):
    name = CharField(max_length=64)         # 车间名称
    key = CharField(max_length=64)          # 唯一标识
    order = IntegerField(default=0)         # 排序
```

### 3. WeeklyResult（周结果数据）

用于存储从CSV文件导入的周检查数据。

```python
class WeeklyResult(models.Model):
    robot = CharField(max_length=64)        # 机器人编号
    shop = CharField(max_length=64)         # 车间
    reference = CharField(max_length=64)    # 参考编号
    a1_e_rate = FloatField(null=True)       # A1错误率
    a2_e_rate = FloatField(null=True)       # A2错误率
    # ... a3-a7_e_rate
    level = CharField(choices=LEVEL_CHOICES, default="L")
```

---

## 三、API 接口设计

### 核心 API 端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/robots/groups/` | GET | 获取车间列表 |
| `/robots/components/` | GET | 获取机器人组件列表 |
| `/robots/components/{id}/` | PATCH | 更新机器人组件 |
| `/robots/components/{id}/error_trend_chart/` | GET | 获取错误率趋势图 |
| `/robots/weekly-results/import_robot_components/` | POST | 导入CSV数据 |
| `/robots/weekly-results/sync_robot_status/` | POST | 同步机器人状态 |

### 1. 获取机器人组件列表

**请求参数**：
```javascript
// frontend/src/api/robots.js

const params = {
  group: "shop1",           // 车间过滤
  tab: "highRisk",          // 标签页: highRisk/all/history
  level: "H",               // 等级过滤: H/M/L/T/C
  axisKeys: "A1,A2",        // 关键轴列表
  axisOk: "false",          // 轴状态: true/false
  markMode: "zero",         // 标记模式: zero/nonzero
  keyword: "搜索关键词",      // 搜索关键词
  page: 1,                  // 页码
  page_size: 20             // 每页数量
}
```

**响应格式**：
```json
{
  "count": 150,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 1,
      "group": { "key": "shop1", "name": "车间1" },
      "robot_id": "R001",
      "partNo": "Table_001",
      "referenceNo": "REF001",
      "number": 1,
      "typeSpec": "Type A",
      "tech": "焊接",
      "mark": 0,
      "remark": "",
      "level": "H",
      "status": "online",
      "checks": {
        "A1": { "ok": true, "value": 0.5 },
        "A2": { "ok": false, "value": 8.2 }
      },
      "isHighRisk": true,
      "riskHistory": []
    }
  ]
}
```

### 2. 后端查询逻辑

```python
# backend/robots/views.py:111-173

def get_queryset(self):
    qs = super().get_queryset()

    # 车间过滤
    group_key = self.request.query_params.get("group")
    if group_key:
        qs = qs.filter(group__key=group_key)

    # 标签页过滤
    tab = self.request.query_params.get("tab")
    if tab == "highRisk":
        qs = qs.filter(level="H")
    elif tab == "history":
        qs = qs.exclude(risk_history=[])

    # 关键词搜索
    keyword = self.request.query_params.get("keyword")
    if keyword:
        qs = qs.filter(
            Q(robot_id__icontains=keyword) |
            Q(part_no__icontains=keyword) |
            Q(reference_no__icontains=keyword)
        )

    # 等级过滤
    level = self.request.query_params.get("level")
    if level:
        qs = qs.filter(level=level)

    # 关键轴状态过滤（复杂逻辑）
    axis_keys = self.request.query_params.get("axisKeys", "").split(",")
    axis_ok = self.request.query_params.get("axisOk")
    if axis_keys and axis_ok is not None:
        axis_ok_bool = str(axis_ok).lower() in {"1", "true", "yes"}
        if axis_ok_bool:
            # 所有指定轴都必须ok
            for k in axis_keys:
                qs = qs.filter(**{f"checks__{k}__ok": True})
        else:
            # 任一指定轴不ok
            axis_q = Q()
            for k in axis_keys:
                axis_q |= Q(**{f"checks__{k}__ok": False})
            qs = qs.filter(axis_q)

    return qs
```

---

## 四、前端页面逻辑

### 1. 页面组件结构

```
DevicesView.vue
├── 车间选择器 (抽屉式面板)
├── 过滤器区域
│   ├── 搜索框
│   ├── 等级选择器
│   ├── 轴状态选择器
│   └── 标记模式选择器
├── 标签页切换
│   ├── 高风险 (highRisk)
│   ├── 所有 (all)
│   └── 历史 (history)
├── 数据表格
│   ├── 车间列
│   ├── 机器人编号列
│   ├── A1-A7 关节状态列
│   ├── 参考编号列（可编辑）
│   ├── 标记列（可编辑）
│   ├── 等级列（可编辑）
│   └── 备注列（可编辑）
├── 分页器
└── 错误率趋势图弹窗
```

### 2. 数据加载流程

```javascript
// frontend/src/views/devices/DevicesView.vue

// 步骤1: 加载车间列表
const loadGroups = async () => {
  groupsData.value = await getRobotGroups()
  // 处理URL参数
  const queryGroup = route.query.group
  if (queryGroup && groupsData.value.find(g => g.key === queryGroup)) {
    selectedGroup.value = queryGroup
  }
}

// 步骤2: 加载机器人数据
const loadRows = async (fetchAll = false) => {
  const params = {
    group: selectedGroup.value,
    tab: tabMap[activeTab.value],
    keyword: searchKeyword.value,
    level: levelFilter.value,
    axisKeys: axisKeysFilter.value.join(','),
    axisOk: axisStateFilter.value,
    markMode: markMode.value,
    page: fetchAll ? 1 : currentPage.value,
    page_size: fetchAll ? 10000 : pageSize.value
  }
  const data = await getRobotComponents(params)
  list.value = data.results
  total.value = data.count
}

// 步骤3: 前端过滤（当用户输入时实时过滤）
const filteredRows = computed(() => {
  let filtered = list

  // 标签页筛选
  if (activeTab.value === 'highRisk') {
    filtered = list.filter(r => r.isHighRisk)
  } else if (activeTab.value === 'history') {
    filtered = list.filter(r => r.riskHistory?.length)
  }

  // 应用所有过滤器
  return filtered.filter(matchesFilters)
})
```

### 3. 编辑功能

```javascript
// 编辑单元格
const handleCellEdit = async (row, field, value) => {
  const updateData = { [field]: value }
  await updateRobotComponent(row.id, updateData)

  // 更新本地数据
  row[field] = value
  ElMessage.success('更新成功')
}
```

### 4. 错误率趋势图

```javascript
// 打开错误率趋势图
const openErrorTrendChart = async (robot, axisKey) => {
  const axisNum = axisKey.replace('A', '')
  const response = await getErrorTrendChart(robot.id, axisNum)

  if (response.success) {
    // 将base64数据转换为data URL
    chartDialogData.value = {
      visible: true,
      title: `${robot.robot_id} - ${axisKey} 关节错误率趋势`,
      chartUrl: `data:image/png;base64,${response.chart_data}`
    }
  }
}
```

### 5. 数据导入功能

```javascript
// 刷新/导入数据
const handleRefresh = async () => {
  const result = await importRobotComponents({})
  ElMessage.success(
    `导入成功！新增 ${result.records_created} 条，更新 ${result.records_updated} 条`
  )
  await loadRows()
}
```

---

## 五、数据可视化

### 1. 关节状态点样式

关节状态点根据错误率显示不同颜色：

```vue
<div
  v-for="(axis, key) in row.checks"
  :key="key"
  class="axis-point"
  :class="{
    'ok': axis.ok,
    'warning': !axis.ok && axis.value < 10,
    'danger': !axis.ok && axis.value >= 10
  }"
  :style="{ backgroundColor: getAxisColor(axis) }"
  @click="openErrorTrendChart(row, key)"
>
  {{ key }}
</div>
```

颜色逻辑：
- 绿色 (ok): 错误率正常
- 黄色 (warning): 错误率异常但 <10%
- 红色 (danger): 错误率 >=10%

### 2. 等级标签样式

```javascript
const levelConfig = {
  'H': { label: '高风险', color: '#f56c6c' },  // 红色
  'M': { label: '中风险', color: '#e6a23c' },  // 橙色
  'L': { label: '低风险', color: '#67c23a' },  // 绿色
  'T': { label: '临时', color: '#909399' },    // 灰色
  'C': { label: '已处理', color: '#409eff' }   // 蓝色
}
```

---

## 六、分页逻辑

系统支持两种分页模式：

### 1. DEMO模式（前端分页）

```javascript
// 前端分页
const pagedRows = computed(() => {
  if (!DEMO_MODE) return filteredRows.value

  const start = (currentPage.value - 1) * pageSize.value
  return filteredRows.value.slice(start, start + pageSize.value)
})
```

### 2. 生产模式（后端分页）

使用 Django REST Framework 的 `PageNumberPagination`：

```python
# settings.py
REST_FRAMEWORK = {
    'PAGE_SIZE': 20,
    'MAX_PAGE_SIZE': 100,
}
```

---

## 七、数据导入流程

### CSV数据导入流程图

```
┌─────────────────┐
│  CSV文件上传     │
└────────┬────────┘
         ↓
┌─────────────────────────────────────┐
│  import_robot_components_csv       │
│  (直接导入到RobotComponent表)       │
└────────┬────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│  1. 解析CSV文件                     │
│  2. 验证数据格式                     │
│  3. 更新或创建RobotComponent记录     │
│  4. 返回导入统计                     │
└────────┬────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│  前端刷新显示最新数据                │
└─────────────────────────────────────┘
```

### 导入命令

```python
# backend/robots/management/commands/import_weekly_results.py

class Command(BaseCommand):
    def handle(self, *args, **options):
        # 读取CSV文件
        # 解析数据
        # 批量创建/更新记录
```

---

## 八、关键代码位置参考

| 功能模块 | 文件路径 | 行号范围 |
|---------|---------|---------|
| 前端页面组件 | `frontend/src/views/devices/DevicesView.vue` | 全文 |
| 前端API定义 | `frontend/src/api/robots.js` | 全文 |
| 后端视图 - RobotComponent | `backend/robots/views.py` | 101-313 |
| 后端视图 - RobotGroup | `backend/robots/views.py` | 32-98 |
| 后端查询逻辑 | `backend/robots/views.py` | 111-173 |
| 错误率趋势图 | `backend/robots/views.py` | 257-313 |
| 数据模型 | `backend/robots/models.py` | 全文 |
| 序列化器 | `backend/robots/serializers.py` | 全文 |
| CSV导入命令 | `backend/robots/management/commands/import_weekly_results.py` | 全文 |

---

## 九、技术栈总结

### 后端
- **框架**: Django REST Framework
- **数据库**: MySQL
- **数据验证**: Serializers
- **分页**: PageNumberPagination
- **图表生成**: Matplotlib

### 前端
- **框架**: Vue 3 (Composition API)
- **UI组件**: Element Plus
- **状态管理**: Ref/Computed
- **路由**: Vue Router
- **HTTP客户端**: Axios

---

## 十、系统特点

1. **实时监控**: 支持多车间机器人状态实时查看
2. **多维度过滤**: 支持按车间、等级、轴状态、标记等多维度过滤
3. **可视化展示**: 关节状态颜色标识、错误率趋势图
4. **便捷编辑**: 支持表格内直接编辑关键信息
5. **数据导入**: 支持CSV文件批量导入数据
6. **响应式设计**: 适配不同屏幕尺寸
